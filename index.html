<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mes EXIT</title>

  <style>
    :root{
      --fg:#1e1e22; --muted:#666; --bg:#fafafa; --card:#fff; --line:#e8e8ee;
      --radius:14px; --shadow:0 6px 20px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .container{max-width:920px;margin:0 auto;padding:20px}
    h1{margin:.2em 0;font-size:32px}
    .subtitle{color:var(--muted);margin:0 0 8px}
    .stats{color:var(--muted)}

    .grid{list-style:none;padding:0;margin:18px 0;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
    .row{cursor:pointer;display:flex;gap:12px}
    .doneToggle{transform:scale(1.2);margin-top:4px}

    .title{font-weight:600;margin:4px 0}
    .meta{font-size:13px;color:var(--muted);margin-bottom:8px}

    /* Badges */
    .badge{padding:2px 8px;border-radius:999px;font-size:13px;margin-right:6px;border:1px solid var(--line)}
    .badge.debutant{background:#e6f8e9;color:#20752b;border-color:#bde5c3}
    .badge.confirme{background:#e6f1fb;color:#19528b;border-color:#b8d0ef}
    .badge.expert{background:#fde8e6;color:#a32216;border-color:#f7bbb4}

    /* Images : ratio + hauteur mini pour √©viter les sauts de mise en page */
    .cover{
      width:100%;
      border-radius:10px;
      border:1px solid var(--line);
      background:#f6f7f9;
      aspect-ratio: 1 / 1;  /* carr√© par d√©faut pour une grille stable */
      min-height: 180px;    /* zone visible m√™me avant chargement */
      object-fit: cover;    /* recadrage propre */
    }
    .foot{padding:6px 0 40px}
  </style>
</head>
<body>
  <header class="container">
    <h1>Mes EXIT</h1>
    <p class="subtitle">Bo√Ætes classiques, images officielles IELLO. Coche ceux d√©j√† termin√©s.</p>
    <div class="stats" aria-live="polite">
      <span id="totalCount">0</span> jeux ‚Ä¢ <span id="doneCount">0</span> termin√©s ‚Ä¢ <span id="progressPct">0%</span> compl√©t√©
    </div>
  </header>

  <main class="container">
    <ul id="gameList" class="grid"></ul>

    <template id="gameItemTpl">
      <li class="card">
        <label class="row">
          <input type="checkbox" class="doneToggle" />
          <div style="flex:1">
            <div class="title"></div>
            <div class="meta"></div>
            <img class="cover" alt="" loading="lazy" referrerpolicy="no-referrer" />
          </div>
        </label>
      </li>
    </template>
  </main>

  <footer class="container foot">
    <small>Images : visuels officiels IELLO. Si une URL directe ne r√©pond pas, la couverture est r√©cup√©r√©e automatiquement depuis la fiche du jeu et m√©moris√©e localement.</small>
  </footer>

  <script>
    const STORAGE_KEYS = { DONE:'exit_done_v1', IMG_CACHE:'exit_img_cache_v1' };
    let done = JSON.parse(localStorage.getItem(STORAGE_KEYS.DONE) || '{}');
    let imgCache = JSON.parse(localStorage.getItem(STORAGE_KEYS.IMG_CACHE) || '{}');

    // util : "D√©butant" -> "debutant", "Confirm√©" -> "confirme"
    const toBadgeClass = s => s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

    // üîß IMPORTANT :
    // - "image": URL directe si on la conna√Æt (les 2025 ci-dessous OK)
    // - "imagePage": lien de la fiche IELLO pour fallback auto (og:image) si l'image directe √©choue
    const GAMES = [
      {
        "id":"exit-intrigue-a-venise",
        "titre":"EXIT ‚Äì Intrigue √† Venise",
        "annee":2025,
        "difficulte":"Confirm√©",
        "editeur":"IELLO",
        "image":"https://iello.fr/wp-content/uploads/2025/07/EXIT_Intrigue-a-Venise_Mockup_light-740x1085.jpg",
        "imagePage":"https://iello.fr/jeux/exit-intrigue-a-venise/"
      },
      {
        "id":"exit-course-poursuite-a-amsterdam",
        "titre":"EXIT ‚Äì Course Poursuite √† Amsterdam",
        "annee":2025,
        "difficulte":"Confirm√©",
        "editeur":"IELLO",
        "image":"https://iello.fr/wp-content/uploads/2024/12/EXIT_Course-Poursuite-a-Amsterdam_Mockup_Light_FR-740x1085.jpg",
        "imagePage":"https://iello.fr/jeux/exit-course-poursuite-a-amsterdam/"
      },

      { "id":"exit-lacademie-de-magie","titre":"EXIT ‚Äì L‚ÄôAcad√©mie de Magie","annee":2024,"difficulte":"D√©butant","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-lacademie-de-magie/" },
      { "id":"exit-levasion-de-prison","titre":"EXIT ‚Äì L‚Äô√©vasion de Prison","annee":2024,"difficulte":"Expert","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-levasion-de-prison/" },
      { "id":"exit-lheritage-du-voyageur","titre":"EXIT ‚Äì L‚Äôh√©ritage du Voyageur","annee":2024,"difficulte":"Confirm√©","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-lheritage-du-voyageur/" },

      { "id":"exit-la-disparition-de-sherlock-holmes","titre":"EXIT ‚Äì La disparition de Sherlock Holmes","annee":2023,"difficulte":"Confirm√©","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-la-disparition-de-sherlock-holmes/" },
      { "id":"exit-le-bandit-de-fortune-city","titre":"EXIT ‚Äì Le Bandit de Fortune City","annee":2023,"difficulte":"Confirm√©","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-le-bandit-de-fortune-city/" },
      { "id":"exit-le-retour-a-la-cabane-abandonnee","titre":"EXIT ‚Äì Le Retour √† la Cabane Abandonn√©e","annee":2023,"difficulte":"Confirm√©","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-le-retour-a-la-cabane-abandonnee/" },

      { "id":"exit-perils-en-terres-du-milieu","titre":"EXIT ‚Äì P√©rils en Terres du Milieu","annee":2022,"difficulte":"D√©butant","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-perils-en-terres-du-milieu/" },
      { "id":"exit-le-cimetiere-des-ombres","titre":"EXIT ‚Äì Le Cimeti√®re des Ombres","annee":2022,"difficulte":"Confirm√©","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-le-cimetiere-des-ombres/" },
      { "id":"exit-la-porte-entre-les-mondes","titre":"EXIT ‚Äì La Porte entre les Mondes","annee":2022,"difficulte":"Confirm√©","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-la-porte-entre-les-mondes/" },

      { "id":"exit-le-vol-vers-linconnu","titre":"EXIT ‚Äì Le Vol vers l‚ÄôInconnu","annee":2021,"difficulte":"D√©butant","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-le-vol-vers-linconnu/" },
      { "id":"exit-laffaire-du-mississippi","titre":"EXIT ‚Äì L‚ÄôAffaire du Mississippi","annee":2021,"difficulte":"Confirm√©","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-laffaire-du-mississippi/" },

      { "id":"exit-la-maison-des-enigmes","titre":"EXIT ‚Äì La Maison des √ânigmes","annee":2020,"difficulte":"D√©butant","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-la-maison-des-enigmes/" },
      { "id":"exit-le-parc-de-lhorreur","titre":"EXIT ‚Äì Le Parc de l‚ÄôHorreur","annee":2020,"difficulte":"D√©butant","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-le-parc-de-lhorreur/" },
      { "id":"exit-les-catacombes-de-leffroi","titre":"EXIT ‚Äì Les Catacombes de l‚ÄôEffroi","annee":2020,"difficulte":"Expert","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-les-catacombes-de-leffroi/" },

      { "id":"exit-le-jeu-le-musee-mysterieux","titre":"EXIT : Le Jeu ‚Äì Le Mus√©e Myst√©rieux","annee":2019,"difficulte":"D√©butant","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-le-jeu-le-musee-mysterieux/" },
      { "id":"exit-le-jeu-le-manoir-sinistre","titre":"EXIT : Le Jeu ‚Äì Le Manoir Sinistre","annee":2019,"difficulte":"Confirm√©","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-le-jeu-le-manoir-sinistre/" },

      { "id":"exit-le-tresor-englouti","titre":"EXIT ‚Äì Le Tr√©sor Englouti","annee":2018,"difficulte":"D√©butant","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-le-tresor-englouti/" },
      { "id":"exit-le-jeu-le-chateau-interdit","titre":"EXIT : Le Jeu ‚Äì Le Ch√¢teau Interdit","annee":2018,"difficulte":"Expert","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-le-jeu-le-chateau-interdit/" },
      { "id":"exit-le-jeu-la-station-polaire","titre":"EXIT : Le Jeu ‚Äì La Station Polaire","annee":2018,"difficulte":"Confirm√©","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-le-jeu-la-station-polaire/" },

      { "id":"exit-le-jeu-le-laboratoire-secret","titre":"EXIT : Le Jeu ‚Äì Le Laboratoire Secret","annee":2017,"difficulte":"Confirm√©","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-le-jeu-le-laboratoire-secret/" },
      { "id":"exit-le-jeu-le-tombeau-du-pharaon","titre":"EXIT : Le Jeu ‚Äì Le Tombeau du Pharaon","annee":2017,"difficulte":"Expert","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-le-jeu-le-tombeau-du-pharaon/" },
      { "id":"exit-le-jeu-la-cabane-abandonnee","titre":"EXIT : Le Jeu ‚Äì La Cabane Abandonn√©e","annee":2017,"difficulte":"Confirm√©","editeur":"IELLO","imagePage":"https://iello.fr/jeux/exit-le-jeu-la-cabane-abandonnee/" }
    ];

    document.addEventListener('DOMContentLoaded', () => render(GAMES));

    function render(games){
      const list = document.getElementById('gameList');
      const tpl = document.getElementById('gameItemTpl');
      list.innerHTML = '';

      const sorted = games.slice().sort((a,b)=> (b.annee - a.annee) || a.titre.localeCompare(b.titre,'fr'));

      for (const g of sorted){
        const node = tpl.content.cloneNode(true);

        // Titre + meta + badge
        node.querySelector('.title').textContent = g.titre;
        const cls = g.difficulte ? toBadgeClass(g.difficulte) : '';
        node.querySelector('.meta').innerHTML =
          (g.difficulte ? `<span class="badge ${cls}">${g.difficulte}</span>` : '') +
          (g.annee ? ` ‚Ä¢ ${g.annee}` : '') +
          (g.editeur ? ` ‚Ä¢ ${g.editeur}` : '');

        // Image : direct si dispo, sinon fallback auto si erreur
        const img = node.querySelector('.cover');
        if (g.image) img.src = g.image;
        img.alt = g.titre;
        img.addEventListener('error', async () => {
          // si on a d√©j√† trouv√© une cover pour ce jeu, on la r√©utilise
          if (imgCache[g.id]) { img.src = imgCache[g.id]; return; }
          // sinon, on tente de r√©cup√©rer og:image de la fiche IELLO
          if (g.imagePage){
            const url = await fetchOgImage(g.imagePage);
            if (url){
              imgCache[g.id] = url;
              localStorage.setItem(STORAGE_KEYS.IMG_CACHE, JSON.stringify(imgCache));
              img.src = url;
            }
          }
        }, {once:true});

        // Checkbox termin√©
        const cb = node.querySelector('.doneToggle');
        cb.checked = !!done[g.id];
        cb.addEventListener('change', () => {
          done[g.id] = cb.checked || undefined;
          if (!cb.checked) delete done[g.id];
          localStorage.setItem(STORAGE_KEYS.DONE, JSON.stringify(done));
          updateStats(sorted.length);
        });

        list.appendChild(node);
      }

      updateStats(sorted.length);
    }

    // R√©cup√®re og:image via un proxy texte (pas de CORS) + normalise l‚ÄôURL
    async function fetchOgImage(pageUrl){
      try{
        const proxied = 'https://r.jina.ai/' + pageUrl.replace(/^https?:\/\//,'');
        const html = await fetch(proxied, {cache:'no-store'}).then(r=>r.text());

        // ordre de recherche : secure_url > og:image > twitter:image
        let m = html.match(/<meta[^>]+property=["']og:image:secure_url["'][^>]+content=["']([^"']+)["']/i);
        let url = m?.[1];
        if (!url){ m = html.match(/<meta[^>]+property=["']og:image["'][^>]+content=["']([^"']+)["']/i); url = m?.[1]; }
        if (!url){ m = html.match(/<meta[^>]+name=["']twitter:image["'][^>]+content=["']([^"']+)["']/i); url = m?.[1]; }

        if (!url) return '';
        url = url.replace(/&amp;|&#038;/g,'&');         // entit√©s HTML -> &
        if (url.startsWith('//')) url = 'https:' + url; // //... -> https://...
        if (!/^https?:\/\//i.test(url)){
          // chemin relatif -> absolu (base iello.fr)
          url = new URL(url.startsWith('/')? url : ('/'+url), 'https://iello.fr').toString();
        }
        return url;
      }catch(e){ return ''; }
    }

    function updateStats(total){
      const doneCount = Object.keys(done).length;
      document.getElementById('totalCount').textContent = total;
      document.getElementById('doneCount').textContent = doneCount;
      document.getElementById('progressPct').textContent = total ? Math.round(doneCount/total*100)+'%' : '0%';
    }
  </script>
</body>
</html>